name: Trigger Jenkins for backend tests

permissions:
  contents: write

on:
  push:
    branches:
      - master
    # Only run when backend files change (exclude frontend)
    paths:
      - 'internal/**'
      - 'models/**'
      - 'dto/**'
      - 'database/**'
      - 'middleware/**'
      - 'router/**'
      - 'service/**'
      - 'main.go'
      - 'go.mod'
      - 'go.sum'
      - 'constant/**'
      - 'utils/**'

jobs:
  detect_and_trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Detect backend test files
        id: detect
        run: |
          # Find test files excluding the frontend directory
          COUNT=$(find . -not -path "./managify-frontend/*" -name '*_test.go' | wc -l || true)
          echo "count=${COUNT}" >> $GITHUB_OUTPUT
          if [ "${COUNT}" -gt 0 ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
          echo "Found backend test files: ${COUNT}"

      - name: Skip if no backend tests found
        if: steps.detect.outputs.found == 'false'
        run: |
          echo "No backend test files found â€” skipping Jenkins trigger."

      - name: Trigger Jenkins job
        if: steps.detect.outputs.found == 'true'
        env:
          JENKINS_URL: ${{ secrets.JENKINS_URL }}
          JENKINS_USER: ${{ secrets.JENKINS_USER }}
          JENKINS_TOKEN: ${{ secrets.JENKINS_TOKEN }}
          JENKINS_JOB: ${{ secrets.JENKINS_JOB_NAME }}
        run: |
          echo "Triggering Jenkins job: ${JENKINS_JOB}"
          # Try to get CSRF crumb if Jenkins has CSRF protection enabled
          CRUMB=$(curl -s "${JENKINS_URL}/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,\":\",//crumb)" --user "${JENKINS_USER}:${JENKINS_TOKEN}" || true)
          echo "Crumb: $CRUMB"
          if [ -n "$CRUMB" ]; then
            curl -X POST "${JENKINS_URL}/job/${JENKINS_JOB}/build" -H "$CRUMB" --user "${JENKINS_USER}:${JENKINS_TOKEN}"
          else
            curl -X POST "${JENKINS_URL}/job/${JENKINS_JOB}/build" --user "${JENKINS_USER}:${JENKINS_TOKEN}"
          fi
          echo "Triggered Jenkins job (requested)."


